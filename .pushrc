#!/usr/bin/env python2.7
from fabric.api import env, execute, lcd, local, abort
from pushlib.copy import *


# override what we're deploying right here
env.clone_path = "push/common"
#env.host_path = "/srv/wwwdata"
#env.host_user = "wwwdata"

# we also want to skip tests on ourself
#env.skip_tests = True

# don't want to require a tag
#env.no_tag = True

# if we're deploying ourselves we must do it from the dev version
if (__file__.startswith(env.host_path)):
    abort("Must deploy push using \"./push\" and not \"push\".")


# override the archive method
class CustomArchiveTask(CopyArchiveTask):
    __doc__ = CopyArchiveTask.__doc__

    def before(self):
        # rename "bin" to "push"
        with lcd(env.release_dir):
            local("{} bin push".format(env.tools['mv']))

        # remove pyc files
        local("{} {} -type f -name \"*.pyc\" -exec {} -rf {{}} +".format(env.tools['find'], env.release_dir, env.tools['rm']))

        # the trailing slashes are for rsync
        execute(CopyDirectoryTask(), 'shared', 'push/')


archiveTask = CustomArchiveTask()
